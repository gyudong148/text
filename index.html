<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주제별 성경 사전 (AI 에디션)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Noto Serif KR for titles, Noto Sans KR for body -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Noto+Serif+KR:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #fdfdfd;
            color: #333333;
        }
        h1, h2, h3, h4, h5 {
            font-family: 'Noto Serif KR', serif;
        }
        textarea::-webkit-scrollbar, .modal-content-area::-webkit-scrollbar, .modal-message-scroll::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-track, .modal-content-area::-webkit-scrollbar-track, .modal-message-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        textarea::-webkit-scrollbar-thumb, .modal-content-area::-webkit-scrollbar-thumb, .modal-message-scroll::-webkit-scrollbar-thumb {
            background: #cccccc;
            border-radius: 10px;
        }
        textarea::-webkit-scrollbar-thumb:hover, .modal-content-area::-webkit-scrollbar-thumb:hover, .modal-message-scroll::-webkit-scrollbar-thumb:hover {
            background: #aaaaaa;
        }
        .modal-content-area, .modal-message-scroll {
            max-height: 75vh;
            overflow-y: auto;
            text-align: left;
            background-color: #f8f9fa; /* Light gray background for modal content area */
            border-radius: 0.75rem;
            color: #333333;
        }
         .modal-content-area {
            padding: 1.5rem;
        }
        .verse-entry {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
            padding: 1rem;
            border: 1px solid #e0e0e0;
            border-radius: 0.75rem;
            background-color: #ffffff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .gemini-btn {
            background-color: #e74c3c; /* Red theme color */
            color: white;
            transition: background-color 0.3s;
        }
        .gemini-btn:hover {
            background-color: #c0392b; /* Darker red */
        }
        .gemini-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-[#fdfdfd] min-h-screen flex flex-col items-center py-12 px-4 sm:px-6">
    <div class="max-w-5xl w-full bg-white shadow-2xl rounded-3xl p-8 sm:p-12 space-y-12 border border-gray-200">
        <!-- Header -->
        <header class="text-center">
            <h1 class="text-5xl sm:text-6xl font-extrabold text-[#e74c3c] mb-4 drop-shadow-sm">주제별 성경 사전</h1>
            <p class="text-xl sm:text-2xl text-[#555555] font-medium tracking-wide">"주의 말씀은 내 발에 등이요 내 길에 빛이니이다" (시 119:105)</p>
        </header>

        <!-- Entry Form -->
        <section class="bg-gray-50 p-8 sm:p-10 rounded-2xl shadow-inner border border-gray-200">
            <h2 class="text-3xl sm:text-4xl font-bold text-[#2c3e50] mb-10 text-center" id="form-title">새로운 주제 추가</h2>
            <form id="entry-form" class="space-y-8">
                <div>
                    <label for="theme" class="block text-[#555555] text-lg font-medium mb-3">주제:</label>
                    <input type="text" id="theme" placeholder="예: 구원, 사랑, 믿음"
                           class="w-full p-5 bg-white border border-[#cccccc] rounded-xl text-[#333333] placeholder-gray-400 focus:ring-2 focus:ring-[#e74c3c] focus:border-[#e74c3c] transition duration-300 shadow-sm" required>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <label for="meaning" class="block text-[#555555] text-lg font-medium">의미:</label>
                        <button type="button" id="gemini-meaning-btn" class="gemini-btn text-sm font-bold py-2 px-4 rounded-lg shadow-md">✨ AI 추천받기</button>
                    </div>
                    <textarea id="meaning" rows="5" placeholder="예: 구원은 단순히 죄에서 벗어나는 것을 넘어, 하나님과의 관계 회복과 영원한 생명을 의미합니다."
                              class="w-full p-5 bg-white border border-[#cccccc] rounded-xl text-[#333333] placeholder-gray-400 focus:ring-2 focus:ring-[#e74c3c] focus:border-[#e74c3c] resize-y transition duration-300 shadow-sm"></textarea>
                </div>
                <div>
                    <label class="block text-[#555555] text-lg font-medium mb-3">말씀 구절 및 설명:</label>
                    <div id="verse-inputs-container" class="space-y-4"></div>
                    <button type="button" id="add-verse-btn"
                            class="mt-6 w-full bg-[#3498db] text-white font-bold py-4 px-8 rounded-xl hover:bg-[#2980b9] focus:outline-none focus:ring-2 focus:ring-[#3498db] focus:ring-offset-2 focus:ring-offset-white transition duration-300 shadow-md">
                        말씀 구절 추가
                    </button>
                </div>
                <div>
                     <div class="flex justify-between items-center mb-3">
                        <label for="connection" class="block text-[#555555] text-lg font-medium">말씀 구절의 연결점 (관주 포함):</label>
                        <button type="button" id="gemini-connection-btn" class="gemini-btn text-sm font-bold py-2 px-4 rounded-lg shadow-md">✨ AI 추천받기</button>
                    </div>
                    <textarea id="connection" rows="15" placeholder="예: 요한복음 3:16은 로마서 5:8과 연결되어 하나님의 무조건적인 사랑을 강조합니다."
                              class="w-full p-5 bg-white border border-[#cccccc] rounded-xl text-[#333333] placeholder-gray-400 focus:ring-2 focus:ring-[#e74c3c] focus:border-[#e74c3c] resize-y transition duration-300 shadow-sm"></textarea>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <label for="forms" class="block text-[#555555] text-lg font-medium">주제의 여러 모양들 (예시 포함):</label>
                        <button type="button" id="gemini-forms-btn" class="gemini-btn text-sm font-bold py-2 px-4 rounded-lg shadow-md">✨ AI 추천받기</button>
                    </div>
                    <textarea id="forms" rows="18" placeholder="예: 구원의 모양: 칭의, 성화, 영화. 사랑의 모양: 아가페, 필리아, 에로스. (구체적인 예시를 들어 설명)"
                              class="w-full p-5 bg-white border border-[#cccccc] rounded-xl text-[#333333] placeholder-gray-400 focus:ring-2 focus:ring-[#e74c3c] focus:border-[#e74c3c] resize-y transition duration-300 shadow-sm"></textarea>
                </div>
                <div>
                    <label for="relatedThemes" class="block text-[#555555] text-lg font-medium mb-3">연결되는 다른 주제들 (쉼표로 구분):</label>
                    <textarea id="relatedThemes" rows="2" placeholder="예: 믿음, 소망, 자비"
                              class="w-full p-5 bg-white border border-[#cccccc] rounded-xl text-[#333333] placeholder-gray-400 focus:ring-2 focus:ring-[#e74c3c] focus:border-[#e74c3c] resize-y transition duration-300 shadow-sm"></textarea>
                </div>
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 pt-6">
                    <button type="submit" id="submit-btn"
                            class="flex-1 bg-[#e74c3c] text-white font-bold py-5 px-8 rounded-xl hover:bg-[#c0392b] focus:outline-none focus:ring-2 focus:ring-[#e74c3c] focus:ring-offset-2 focus:ring-offset-white transition duration-300 shadow-lg text-xl">
                        주제 추가
                    </button>
                    <button type="button" id="cancel-edit-btn"
                            class="flex-1 bg-gray-400 text-white font-bold py-5 px-8 rounded-xl hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2 focus:ring-offset-white transition duration-300 shadow-lg hidden text-xl">
                        수정 취소
                    </button>
                </div>
            </form>
        </section>

        <!-- Dictionary Entries Display Area -->
        <section>
            <h2 class="text-3xl sm:text-4xl font-bold text-[#2c3e50] mb-10 text-center">나의 주제별 사전 목록</h2>
            <div id="entries-list" class="space-y-8">
                <p class="text-gray-500 text-center text-lg" id="loading-message">사전 항목을 불러오는 중...</p>
            </div>
        </section>
        
        <footer class="text-center mt-12 pt-8 border-t border-gray-200">
            <p id="user-id-display" class="text-xs text-gray-400"></p>
        </footer>
    </div>

    <!-- Custom Modal for Confirmations/Alerts/Details -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
        <div id="modal-content-box" class="bg-white p-8 sm:p-10 rounded-2xl shadow-2xl max-w-2xl w-full text-center border border-gray-200 flex flex-col">
            <h3 id="modal-title" class="text-3xl sm:text-4xl font-bold text-[#e74c3c] mb-8 hidden"></h3>
            <div id="modal-message" class="text-lg sm:text-xl text-[#333333] mb-8 flex-grow"></div>
            <div id="modal-buttons" class="flex justify-center space-x-4 sm:space-x-6">
                <button id="modal-copy-btn" class="bg-green-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-green-700 hidden">내용 복사</button>
                <button id="modal-confirm-btn" class="bg-red-600 text-white font-bold py-3 px-6 sm:py-4 sm:px-8 rounded-xl hover:bg-red-700 hidden">확인</button>
                <button id="modal-cancel-btn" class="bg-gray-400 text-white font-bold py-3 px-6 sm:py-4 sm:px-8 rounded-xl hover:bg-gray-500">닫기</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-bible-dictionary';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const geminiApiKey = "AIzaSyABM_amTw-898hydlYgbS-eqJQ2AoWK8AI"; // API Key inserted here

        let app, db, auth, userId = null;
        let isAuthReady = false;
        let currentEditingEntryId = null;
        let unsubscribe = null;

        // --- DOM Elements ---
        const entryForm = document.getElementById('entry-form');
        const formTitle = document.getElementById('form-title');
        const themeInput = document.getElementById('theme');
        const meaningTextarea = document.getElementById('meaning');
        const verseInputsContainer = document.getElementById('verse-inputs-container');
        const addVerseBtn = document.getElementById('add-verse-btn');
        const connectionTextarea = document.getElementById('connection');
        const formsTextarea = document.getElementById('forms');
        const relatedThemesTextarea = document.getElementById('relatedThemes');
        const entriesList = document.getElementById('entries-list');
        const loadingMessage = document.getElementById('loading-message');
        const submitBtn = document.getElementById('submit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const userIdDisplay = document.getElementById('user-id-display');

        const customModal = document.getElementById('custom-modal');
        const modalContentBox = document.getElementById('modal-content-box');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalCopyBtn = document.getElementById('modal-copy-btn');

        // Gemini Buttons
        const geminiMeaningBtn = document.getElementById('gemini-meaning-btn');
        const geminiConnectionBtn = document.getElementById('gemini-connection-btn');
        const geminiFormsBtn = document.getElementById('gemini-forms-btn');

        const DELETE_PASSWORD = "0091";

        // --- Gemini API Call ---
        async function callGemini(prompt, button) {
            if (!geminiApiKey) {
                showCustomModal("API 키가 설정되지 않았습니다. 관리자에게 문의하세요.");
                return null;
            }
            const originalButtonText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = `<svg class="animate-spin h-5 w-5 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API 요청 실패: ${response.status} ${errorBody}`);
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts[0].text) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Gemini API 응답에 유효한 내용이 없습니다.", result);
                    showCustomModal("AI로부터 응답을 받지 못했습니다. 응답 구조를 확인해주세요.");
                    return null;
                }
            } catch (error) {
                console.error("Gemini API 호출 오류:", error);
                showCustomModal(`AI 기능 사용 중 오류가 발생했습니다: ${error.message}`);
                return null;
            } finally {
                button.disabled = false;
                button.innerHTML = originalButtonText;
            }
        }

        // --- Modal Functions ---
        function showCustomModal(content, title = '', isConfirm = false, inputType = 'none', showCopy = false) {
            return new Promise((resolve) => {
                modalTitle.textContent = title;
                modalTitle.classList.toggle('hidden', !title);
                
                modalMessage.classList.remove('text-center', 'text-left', 'modal-message-scroll');
                if (showCopy) {
                    modalMessage.classList.add('text-left', 'modal-message-scroll');
                } else {
                    modalMessage.classList.add('text-center');
                }

                modalConfirmBtn.classList.add('hidden');
                modalCopyBtn.classList.add('hidden');
                modalConfirmBtn.onclick = null;
                modalCancelBtn.onclick = null;
                modalCopyBtn.onclick = null;

                if (inputType !== 'none') {
                    modalMessage.innerHTML = `${content}<input type="${inputType}" id="modal-input" class="w-full p-4 mt-6 border border-[#cccccc] rounded-lg" placeholder="${inputType === 'password' ? '비밀번호' : '입력'}">`;
                    const modalInput = document.getElementById('modal-input');
                    modalInput.focus();
                    modalInput.addEventListener('keypress', (e) => e.key === 'Enter' && isConfirm && modalConfirmBtn.click());
                } else {
                    modalMessage.innerHTML = content;
                }

                const closeModal = (value) => {
                    customModal.classList.add('hidden');
                    customModal.classList.remove('flex');
                    resolve(value);
                };

                if (isConfirm) {
                    modalConfirmBtn.classList.remove('hidden');
                    modalConfirmBtn.onclick = () => {
                        const inputValue = inputType !== 'none' ? document.getElementById('modal-input').value : true;
                        closeModal(inputValue);
                    };
                    modalCancelBtn.onclick = () => closeModal(false);
                } else {
                    modalConfirmBtn.classList.add('hidden');
                    modalCancelBtn.onclick = () => closeModal(true);
                }
                
                if (showCopy) {
                    modalCopyBtn.classList.remove('hidden');
                    modalCopyBtn.onclick = () => {
                        const textToCopy = modalMessage.innerText;
                        const textArea = document.createElement("textarea");
                        textArea.value = textToCopy;
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            showCustomModal("내용이 복사되었습니다!", "알림");
                        } catch (err) {
                            console.error('복사 실패:', err);
                            showCustomModal("복사에 실패했습니다.", "오류");
                        }
                        document.body.removeChild(textArea);
                    };
                }
                
                customModal.classList.remove('hidden');
                customModal.classList.add('flex');
            });
        }

        // --- Firebase & Auth ---
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        userIdDisplay.textContent = `사용자 ID: ${userId}`;
                        setupRealtimeListener();
                    } else if (!initialAuthToken) {
                        await signInAnonymously(auth);
                    }
                });

                if (initialAuthToken && !auth.currentUser) {
                    await signInWithCustomToken(auth, initialAuthToken);
                }
            } catch (error) {
                console.error("Firebase 초기화 오류:", error);
                showCustomModal(`Firebase 초기화 중 오류: ${error.message}`);
            }
        }

        // --- Firestore Real-time Listener ---
        function setupRealtimeListener() {
            if (!db || !userId || !isAuthReady) return;
            if (unsubscribe) unsubscribe();

            const entriesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/thematicDictionary`);
            const q = query(entriesCollectionRef);

            unsubscribe = onSnapshot(q, (snapshot) => {
                loadingMessage.classList.add('hidden');
                const entries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                entries.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                renderEntries(entries);
            }, (error) => {
                console.error("실시간 업데이트 오류:", error);
                showCustomModal(`데이터 로딩 중 오류: ${error.message}`);
                loadingMessage.textContent = '데이터를 불러오지 못했습니다.';
                loadingMessage.classList.remove('hidden');
            });
        }

        // --- UI Rendering ---
        function renderEntries(entries) {
            entriesList.innerHTML = '';
            if (entries.length === 0) {
                entriesList.innerHTML = '<p class="text-gray-500 text-center text-lg">아직 추가된 주제가 없습니다.</p>';
                return;
            }
            entries.forEach(entry => displayEntry(entry));
        }

        function displayEntry(entry) {
            const entryDiv = document.createElement('div');
            entryDiv.id = `entry-${entry.id}`;
            entryDiv.className = 'bg-white border border-gray-200 rounded-xl p-6 sm:p-8 shadow-md hover:shadow-lg transition-shadow duration-300 space-y-4';
            
            const displayMeaning = entry.meaning ? entry.meaning.substring(0, 100) + (entry.meaning.length > 100 ? '...' : '') : '없음';
            const displayDate = entry.timestamp?.toDate() ? new Date(entry.timestamp.toDate()).toLocaleString('ko-KR') : '알 수 없음';

            entryDiv.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-2xl font-bold text-[#e74c3c] cursor-pointer hover:text-[#c0392b]">${entry.theme}</h3>
                    <div class="flex space-x-3">
                        <button class="edit-btn bg-[#3498db] text-white p-3 rounded-full hover:bg-[#2980b9] shadow-md" title="수정"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                        <button class="delete-btn bg-red-600 text-white p-3 rounded-full hover:bg-red-700 shadow-md" title="삭제"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                    </div>
                </div>
                <p class="text-[#555555]"><strong>의미:</strong> <span class="text-gray-700">${displayMeaning}</span></p>
                <p class="text-sm text-gray-400 text-right">기록 시간: ${displayDate}</p>
            `;
            entriesList.appendChild(entryDiv);

            entryDiv.querySelector('h3').addEventListener('click', () => showEntryDetails(entry));
            entryDiv.querySelector('.edit-btn').addEventListener('click', (e) => { e.stopPropagation(); editEntry(entry); });
            entryDiv.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); deleteEntry(entry.id); });
        }

        function showEntryDetails(entry) {
            const versesHtml = (entry.verse && entry.verse.length > 0)
                ? entry.verse.map(v => `<div class="p-4 bg-gray-100 rounded-lg shadow-sm mb-3 border"><p><strong>구절:</strong> <span class="text-[#3498db]">${v.verse}</span></p><p><strong>설명:</strong> ${v.explanation || '없음'}</p></div>`).join('')
                : '<p class="text-gray-500">말씀 구절 없음</p>';
            
            const createSection = (title, content) => {
                const formattedContent = content ? content.replace(/\n/g, '<br>') : '없음';
                return `
                    <div class="p-5 bg-white rounded-lg border border-gray-200 shadow-sm">
                        <h5 class="text-lg font-semibold text-[#2c3e50] mb-3">${title}</h5>
                        <p class="text-gray-700 whitespace-normal">${formattedContent}</p>
                    </div>`;
            };

            const detailContent = `
                <div class="modal-content-area space-y-5">
                    ${createSection('의미', entry.meaning)}
                    <div class="p-5 bg-white rounded-lg border border-gray-200 shadow-sm">
                        <h5 class="text-lg font-semibold text-[#2c3e50] mb-3">말씀 구절</h5>
                        <div class="mt-3">${versesHtml}</div>
                    </div>
                    ${createSection('말씀 구절의 연결점', entry.connection)}
                    ${createSection('주제의 여러 모양들', entry.forms)}
                    ${createSection('연결되는 다른 주제들', entry.relatedThemes)}
                    
                    <div class="p-5 bg-red-50 rounded-lg border border-red-200 mt-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button id="gemini-sermon-btn" class="gemini-btn font-bold py-3 px-4 rounded-lg shadow-md w-full">✨ 설교 개요 생성</button>
                            <button id="gemini-meditation-btn" class="gemini-btn font-bold py-3 px-4 rounded-lg shadow-md w-full">✨ 묵상 질문 생성</button>
                        </div>
                    </div>
                </div>`;
            showCustomModal(detailContent, `${entry.theme} 상세 내용`);
            
            document.getElementById('gemini-sermon-btn').addEventListener('click', (e) => handleGeminiGeneration('sermon', entry, e.target));
            document.getElementById('gemini-meditation-btn').addEventListener('click', (e) => handleGeminiGeneration('meditation', entry, e.target));
        }

        // --- Form & Input Handling ---
        function addVerseInput(verseText = '', explanationText = '') {
            const verseEntryDiv = document.createElement('div');
            verseEntryDiv.className = 'verse-entry';
            verseEntryDiv.innerHTML = `
                <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-3 w-full">
                    <input type="text" placeholder="말씀 구절 (예: 요 3:16)" value="${verseText}" class="verse-input flex-grow p-3 bg-white border rounded-lg" required>
                    <textarea rows="1" placeholder="간단한 설명" class="explanation-textarea w-full sm:w-2/3 p-3 bg-white border rounded-lg resize-y">${explanationText}</textarea>
                    <button type="button" class="remove-verse-btn bg-red-500 text-white font-bold p-3 rounded-lg hover:bg-red-600 ml-0 sm:ml-3 mt-3 sm:mt-0">삭제</button>
                </div>`;
            verseInputsContainer.appendChild(verseEntryDiv);
            verseEntryDiv.querySelector('.remove-verse-btn').addEventListener('click', () => verseEntryDiv.remove());
        }

        function getVersesFromForm() {
            return Array.from(verseInputsContainer.querySelectorAll('.verse-entry')).map(entryDiv => ({
                verse: entryDiv.querySelector('.verse-input').value.trim(),
                explanation: entryDiv.querySelector('.explanation-textarea').value.trim()
            })).filter(v => v.verse);
        }

        function resetForm() {
            entryForm.reset();
            verseInputsContainer.innerHTML = '';
            addVerseInput();
            currentEditingEntryId = null;
            formTitle.textContent = '새로운 주제 추가';
            submitBtn.textContent = '주제 추가';
            cancelEditBtn.classList.add('hidden');
        }

        // --- CRUD ---
        entryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady || !userId) {
                showCustomModal("인증이 완료되지 않았습니다.");
                return;
            }
            const verses = getVersesFromForm();
            if (verses.length === 0) {
                showCustomModal("말씀 구절을 하나 이상 입력해야 합니다.");
                return;
            }
            const entryData = {
                theme: themeInput.value.trim(),
                meaning: meaningTextarea.value.trim(),
                verse: verses,
                connection: connectionTextarea.value.trim(),
                forms: formsTextarea.value.trim(),
                relatedThemes: relatedThemesTextarea.value.trim(),
                userId: userId
            };
            if (!entryData.theme) {
                showCustomModal("주제는 필수 입력 항목입니다.");
                return;
            }

            try {
                if (currentEditingEntryId) {
                    const entryRef = doc(db, `artifacts/${appId}/users/${userId}/thematicDictionary`, currentEditingEntryId);
                    await updateDoc(entryRef, entryData);
                    showCustomModal("주제가 성공적으로 수정되었습니다!");
                } else {
                    entryData.timestamp = serverTimestamp();
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/thematicDictionary`), entryData);
                    showCustomModal("새로운 주제가 성공적으로 추가되었습니다!");
                }
                resetForm();
            } catch (error) {
                console.error("문서 추가/수정 오류: ", error);
                showCustomModal(`오류: ${error.message}`);
            }
        });

        function editEntry(entry) {
            currentEditingEntryId = entry.id;
            formTitle.textContent = '주제 수정';
            submitBtn.textContent = '수정 완료';
            cancelEditBtn.classList.remove('hidden');

            themeInput.value = entry.theme;
            meaningTextarea.value = entry.meaning || '';
            connectionTextarea.value = entry.connection || '';
            formsTextarea.value = entry.forms || '';
            relatedThemesTextarea.value = entry.relatedThemes || '';

            verseInputsContainer.innerHTML = '';
            if (entry.verse && entry.verse.length > 0) {
                entry.verse.forEach(v => addVerseInput(v.verse, v.explanation));
            } else {
                addVerseInput();
            }
            entryForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        async function deleteEntry(entryId) {
            const password = await showCustomModal("삭제하려면 비밀번호를 입력하세요:", "비밀번호 확인", true, 'password');
            if (password === false) return;

            if (password === DELETE_PASSWORD) {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/thematicDictionary`, entryId));
                    showCustomModal("주제가 삭제되었습니다!");
                    if (currentEditingEntryId === entryId) resetForm();
                } catch (error) {
                    console.error("문서 삭제 오류: ", error);
                    showCustomModal(`삭제 중 오류: ${error.message}`);
                }
            } else {
                showCustomModal("비밀번호가 틀립니다.");
            }
        }

        // --- Gemini Feature Handlers ---
        function sanitizeAiResponse(text) {
            // Basic markdown removal
            return text
                .replace(/(\*\*|__)(.*?)\1/g, '$2') // bold
                .replace(/(\*|_)(.*?)\1/g, '$2')   // italic
                .replace(/#{1,6}\s/g, '')          // headings
                .replace(/^- /gm, '');             // list items
        }

        async function handleGeminiGeneration(type, entry, button) {
            const versesText = entry.verse.map(v => v.verse).join(', ');
            let prompt = '';
            let title = '';

            const promptSuffix = " 응답은 마크다운 형식(**, *, # 등)을 사용하지 말고, 일반 텍스트로만 작성해주세요.";

            switch (type) {
                case 'sermon':
                    title = `${entry.theme} 설교 개요 (AI 추천)`;
                    prompt = `당신은 성경에 정통한 목사입니다. 다음 성경 주제와 핵심 구절들을 바탕으로, 성도들이 이해하기 쉬운 설교 개요를 작성해주세요. 서론, 본론 (3가지 대지), 결론, 그리고 적용 질문을 포함해주세요.\n\n- 주제: ${entry.theme}\n- 핵심 구절: ${versesText}\n- 주제 의미: ${entry.meaning}` + promptSuffix;
                    break;
                case 'meditation':
                    title = `${entry.theme} 묵상 질문 (AI 추천)`;
                    prompt = `성경 주제 '${entry.theme}'와 관련 구절들(${versesText})에 대해 깊이 묵상할 수 있는 질문 5가지를 만들어줘. 이 질문들은 개인적인 신앙 성찰과 삶의 적용을 돕는 방향으로 작성해줘.` + promptSuffix;
                    break;
            }

            const result = await callGemini(prompt, button);
            if (result) {
                const sanitizedResult = sanitizeAiResponse(result);
                const formattedResult = sanitizedResult.replace(/\n/g, '<br>');
                showCustomModal(`<div class="whitespace-normal text-left font-sans">${formattedResult}</div>`, title, false, 'none', true);
            }
        }
        
        async function handleFormGeminiRequest(e, promptGenerator) {
             const theme = themeInput.value.trim();
            if (!theme) {
                showCustomModal("먼저 주제를 입력해주세요.");
                return;
            }
            const prompt = promptGenerator(theme) + " 응답은 마크다운 형식(**, *, # 등)을 사용하지 말고, 일반 텍스트로만 작성해주세요.";
            const result = await callGemini(prompt, e.target);
            if (result) {
                const sanitizedResult = sanitizeAiResponse(result);
                const formattedResult = sanitizedResult.replace(/\n/g, '<br>');
                showCustomModal(`<div class="whitespace-normal text-left font-sans">${formattedResult}</div>`, "AI 추천 내용", false, 'none', true);
            }
        }

        geminiMeaningBtn.addEventListener('click', (e) => {
            handleFormGeminiRequest(e, (theme) => `성경 주제 '${theme}'에 대한 신학적 의미를 목회자적인 관점에서 2-3 문장으로 설명해줘.`);
        });

        geminiConnectionBtn.addEventListener('click', (e) => {
            const verses = getVersesFromForm().map(v => v.verse).join(', ');
            if (!verses) {
                showCustomModal("먼저 하나 이상의 말씀 구절을 입력해주세요.");
                return;
            }
            handleFormGeminiRequest(e, (theme) => `성경 주제 '${theme}'와 관련된 주요 성경 구절들(${verses})이 서로 어떻게 신학적으로 연결되는지, 그리고 이 주제가 성경 전체의 맥락에서 어떻게 나타나는지 설명해줘.`);
        });

        geminiFormsBtn.addEventListener('click', (e) => {
             handleFormGeminiRequest(e, (theme) => `성경 주제 '${theme}'가 성경 안에서 나타나는 다양한 형태나 측면들을 예시와 함께 설명해줘. (예: 사랑의 종류 - 아가페, 필리아 등)`);
        });


        // --- Initial Setup ---
        addVerseBtn.addEventListener('click', () => addVerseInput());
        cancelEditBtn.addEventListener('click', resetForm);
        window.onload = () => {
            initializeFirebase();
            addVerseInput();
        };
    </script>
</body>
</html>
